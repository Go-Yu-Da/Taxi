asyncapi: 3.0.0
id: 'urn:pricing-service'
info:
  title: Pricing Service
  version: 1.0.0
  description: Микросервис для расчета стоимости поездок через gRPC
  contact:
    name: API Support
    email: support@example.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  grpc-server:
    host: localhost:50051
    protocol: grpc
    description: gRPC server for internal pricing calculations

defaultContentType: application/json

channels:
  CalculatePrice:
    address: PricingService/CalculatePrice
    description: gRPC endpoint для расчета стоимости поездки
    messages:
      PriceRequest:
        $ref: '#/components/messages/PriceRequest'
      PriceResponse:
        $ref: '#/components/messages/PriceResponse'

operations:
  CalculatePriceOperation:
    action: receive
    channel:
      $ref: '#/channels/CalculatePrice'
    messages:
      - $ref: '#/channels/CalculatePrice/messages/PriceRequest'
    reply:
      channel:
        $ref: '#/channels/CalculatePrice'
      messages:
        - $ref: '#/channels/CalculatePrice/messages/PriceResponse'


components:
  messages:
    PriceRequest:
      name: PriceRequest
      title: Запрос на расчет стоимости
      summary: Запрос на расчет стоимости поездки
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PriceRequest'
      headers:
        type: object
        properties:
          id:
            type: string
            description: Уникальный идентификатор запроса
          timestamp:
            type: string
            format: date-time
            description: Время создания запроса
          service:
            type: string
            default: "matching-service"
            description: Сервис-источник запроса

    PriceResponse:
      name: PriceResponse
      title: Ответ с расчетом стоимости
      summary: Рассчитанная стоимость поездки
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PriceResponse'
      headers:
        type: object
        properties:
          id:
            type: string
            description: Уникальный идентификатор ответа
          timestamp:
            type: string
            format: date-time
            description: Время создания ответа
          correlation_id:
            type: string
            description: ID исходного запроса

  schemas:
    PriceRequest:
      type: object
      required:
        - ride_id
        - pickup_location
        - destination
        - ride_type
      properties:
        ride_id:
          type: string
          description: ID поездки
          example: "ride_12345"
        pickup_location:
          $ref: '#/components/schemas/Location'
        destination:
          $ref: '#/components/schemas/Location'
        ride_type:
          type: string
          enum: [economy, comfort, business, premium]
          description: Тип поездки
        route_info:
          type: object
          description: Информация о маршруте (если доступна)
          properties:
            distance_meters:
              type: number
              description: Расстояние в метрах
            duration_seconds:
              type: number
              description: Время в пути в секундах
        surge_multiplier:
          type: number
          minimum: 1.0
          default: 1.0
          description: Коэффициент повышенного спроса
        timestamp:
          type: string
          format: date-time
          description: Время запроса расчета

    PriceResponse:
      type: object
      required:
        - ride_id
        - price
        - currency
        - calculated_at
      properties:
        ride_id:
          type: string
          description: ID поездки
        price:
          type: number
          minimum: 0
          description: Итоговая стоимость
        currency:
          type: string
          default: "RUB"
          description: Валюта
        price_breakdown:
          type: object
          description: Детализация стоимости
          properties:
            base_fare:
              type: number
              description: Базовая стоимость
            distance_fare:
              type: number
              description: Стоимость за расстояние
            time_fare:
              type: number
              description: Стоимость за время
            surge_multiplier:
              type: number
              description: Коэффициент спроса
            service_fee:
              type: number
              description: Сервисный сбор
        calculated_at:
          type: string
          format: date-time
          description: Время расчета стоимости

    Location:
      type: object
      required:
        - lat
        - lng
      properties:
        lat:
          type: number
          minimum: -90
          maximum: 90
          example: 55.7558
        lng:
          type: number
          minimum: -180
          maximum: 180
          example: 37.6173
        address:
          type: string
          description: Адрес локации